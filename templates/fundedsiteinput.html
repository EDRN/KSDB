{% extends request.GET.modal|yesno:'lib.html,base.html' %}
{% block content %}        
        <script>
            function initInstPersonnel(pis, staffs) {
                $('#pis').html("");
                $.each(pis, function(key, value) { 
                    $('#pis').append($("<option></option>")
                        .attr("value",value[0])
                        .text(value[1]+" "+value[2])); 
                });
                $('#staff').html("");
                $.each(staffs, function(key, value) { 
                    $('#staff').append($("<option></option>")
                        .attr("value",value[0])
                        .text(value[1]+" "+value[2])); 
                });

            }
            function fillfundedsiteform() {
                    $('#pis').val({{pi_link_id}});
                    $('#staff').val({{staff_link_id}});
                    $('#organs').val({{organ_link_id}});
                    $('#projects').val({{project_link_id}});
                    $('#institutions').val({{institution_link_id}});
                    $('#description').val("{{description}}");
                    $('#status').val("{{status}}");
            }
            $(document).ready( function () {
                updateLists("institution", "institutions");
                updateLists("project", "projects");
                updateLists("organ", "organs");
                {% ifequal action "Edit" %}
                    //sleep(500).then(() => {
                    //    fillfundedsiteform();
                    //});
                    setInterval(fillfundedsiteform, 500);
                {% endifequal %}
        } );
        </script>
    <div class="container">
        <div class="col-md-12 text-center">
            <H2>{{ action }} Participating Site {{ id }}</H2>
            <p>
                Please update the KSDB database with accurate participating site information.
            </p>
            <br>
        </div>
        <div class="col-md-12">
            <div class="col-md-12">
            <form id="fundedsiteinput" action="/ksdb/fundedsiteinput/" method="post" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="col-md-6">
                <fieldset class="form-group">
                <label for="status">Status</label>
                <select class="form-control" id="status" name="status">
                    <option value="Not Funded">Not Funded</option>
                    <option value="Funded">Funded</option>
                </select>
                </fieldset>
                <fieldset class="form-group">
                <label for="institutions">Institution <a data-toggle="modal" id="addinstitution" data-target="#modal" onclick="startModal(this)" target="institutions" href="institution">(Add Institution)</a></label>
                <select multiple class="form-control" size=7 id="institutions" name="institutions">
                </select>
                </fieldset>
                <fieldset class="form-group">
                <label for="projects">Projects  <a data-toggle="modal" id="addproject" data-target="#modal" onclick="startModal(this)" target="projects" href="project">(Add Project)</a></label>
                <select multiple class="form-control" size=7 id="projects" name="projects">
                </select>
                </fieldset>
                <fieldset class="form-group">
                <label for="description">Participating Site Description</label>
                <textarea class="form-control" id="description" name="description" rows="6"></textarea>
                </fieldset>
                </div>
                <div class="col-md-6">
                <fieldset class="form-group">
                <label for="pis">Principal Investigators - please select institution first</label>
                <select multiple class="form-control" size=7 id="pis" name="pis">
                </select>
                </fieldset>
                <fieldset class="form-group">
                <label for="staff">Additional Staff - please select institution first</label>
                <select multiple class="form-control" size=7 id="staff" name="staff">
                </select>
                </fieldset>
                <fieldset class="form-group">
                <label for="organs">Organs <a data-toggle="modal" id="addorgan" data-target="#modal" onclick="startModal(this)" target="organs" href="organ">(Add Organ)</a></label>
                <select multiple class="form-control" size=7 id="organs" name="organs">
                </select>
                </fieldset>
                {% ifequal action "Edit" %}
                <input type="hidden" name="action" value="edit">
                <input type="hidden" name="fundedsiteid" value="{{id}}">
                {% endifequal %}
                {% ifequal action "New" %}
                <input type="hidden" name="action" value="new">
                {% endifequal %}
                </div>
            </form>
            </div>
            <div class="col-md-12">
                <font color="red"><center><div id="results"></div></center></font>
            </div>
            <div class="col-md-12">
            <center>
            <button type="button" class="btn btn-success" id="submit-fundedsite" type="button" >Add</button>
            <button type="button" class="btn btn-danger" id="cancel-fundedsite" onClick="window.location = '/ksdb/view?tabpage=fundedsite';" type="button" >Cancel</button>
            </center>
            </div>
        </div>
    </div>

	<script>
        var submitButton = document.querySelector("#submit-fundedsite");
        var fundedsiteform = $('#fundedsiteinput');
        submitButton.addEventListener("click", function () {
            $.ajax({
                url : fundedsiteform.attr('action'),
                type : 'POST',
                data : fundedsiteform.serialize(),
                success : function (response) {
                    if(response.Success){
                        alert(response.Message);
                        window.location = '/ksdb/view?tabpage=fundedsite';
                    }else{
                        $('span.label-danger').remove();
                        jQuery.each(jQuery.parseJSON(response.Message), function(i, val) {
                            var $lab_span = $('<span>');
                            $lab_span.attr("class", "label label-danger");
                            $lab_span.html(val);
                            $('#'+i).parent().append($lab_span, '\n');
                        });
                        $('#results').html("<font color='red'>Please fix the above form input errors</font>");
                    }
                },
                error : function(xhr, status, error) {
                    alert("Error: "+xhr.responseText);
                }
            });
        });
        $('#institutions').change(function () {
            $.ajax({
                url : fundedsiteform.attr('action'),
                type : 'POST',
                data : fundedsiteform.serialize()+"&instchange=1",
                success : function (response) {
                    initInstPersonnel(response.Personnel, response.Personnel);
                },
                error : function(xhr, status, error) {
                    alert("Error: "+xhr.responseText);
                }
            });
        });
	</script>
{% endblock %}
